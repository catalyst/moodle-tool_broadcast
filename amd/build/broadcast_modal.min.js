define ("tool_broadcast/broadcast_modal",["core/str","core/modal_factory","core/modal_events","core/ajax","core/notification"],function(a,b,c,d,e){var f={},g,h,i="<p class=\"text-center\"><i class=\"fa fa-spinner fa-pulse fa-2x fa-fw\"></i></p>",j={},k=function(){d.call([{methodname:"tool_broadcast_get_broadcasts",args:{contextid:g}}])[0].done(function(a){var b=JSON.parse(a);for(var c in b){var d=b[c].id;j[d]=b[c]}}).fail(function(){window.console.error(new Error("Failed to get broadcast messages"))})},l=function(){if(document.hasFocus()){d.call([{methodname:"tool_broadcast_check_broadcasts",args:{contextid:g}}],!0,!1)[0].done(function(a){var b=JSON.parse(a);if(b){k()}}).fail(function(){window.console.error(new Error("Failed to check broadcast messages"))})}},m=function(a){if(!h.getRoot()[0].classList.contains("show")){h.setTitle(a.title);h.setBody(a.body);h.footer[0].dataset.id=a.id;h.show();delete j[a]}},n=function(a){var b="tool-broadcast-notification-"+a.id,c=document.getElementById(b);if(null===c){var d=document.createElement("span"),f=document.createElement("h4"),g=document.createElement("span");d.id=b;f.classList.add("alert-heading");f.innerHTML=a.title;g.innerHTML=a.body;d.appendChild(f);d.appendChild(g);e.addNotification({message:d.outerHTML,type:"warn"});delete j[a]}},o=function(){if(document.hasFocus()){for(var a in j){if(1==j[a].mode){m(j[a])}else if(2==j[a].mode){n(j[a])}else if(3==j[a].mode){m(j[a]);n(j[a])}break}}},p=function(){h.setBody(i);var a=h.footer[0].dataset.id;delete j[a];d.call([{methodname:"tool_broadcast_acknowledge_broadcast",args:{contextid:g,broadcastid:a}}])[0].fail(function(){e.exception(new Error("Failed to acknowledge broadcast messages"))})},q=function(a){var b=a.target.tagName.toLowerCase();if("button"===b&&"user-notifications"==a.target.parentElement.parentElement.id){for(var c=a.target.parentElement.childNodes,f=0;f<c.length;f++){if(c[f].tagName!==void 0&&"span"===c[f].tagName.toLowerCase()){var h=c[f].id.substring(28);delete j[h];d.call([{methodname:"tool_broadcast_acknowledge_broadcast",args:{contextid:g,broadcastid:h}}])[0].fail(function(){e.exception(new Error("Failed to acknowledge broadcast messages"))})}}}},r=function(){return new Promise(function(d,e){a.get_string("loading","tool_broadcast").then(function(a){var e=document.createElement("input");e.type="button";e.value="Acknowledge";e.id="tool-broadcast-accept-broadcast";e.classList.add("btn","btn-primary","d-flex","ml-auto","mr-auto");b.create({type:b.types.DEFAULT,title:a,body:i,footer:e.outerHTML,large:!0}).done(function(a){h=a;h.getRoot().on("click","#tool-broadcast-accept-broadcast",function(a){a.preventDefault();h.hide()});h.getRoot().on(c.hidden,p);d()})}).catch(function(){e(new Error("Failed to load string: loading"))})})};f.init=function(a){g=a;var b=Math.floor(Math.random()*(6e4-45000+1))+45000;r().then(function(){l();setInterval(l,b);setInterval(o,5e3)}).catch(function(){e.exception(new Error("Failed to create broadcast modal"))});document.addEventListener("click",q)};return f});
//# sourceMappingURL=broadcast_modal.min.js.map
