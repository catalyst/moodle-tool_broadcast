define ("tool_broadcast/broadcast_modal",["core/str","core/modal_factory","core/modal_events","core/ajax","core/notification"],function(a,b,c,d,e){var f={},g,h,i,j="<p class=\"text-center\"><i class=\"fa fa-spinner fa-pulse fa-2x fa-fw\"></i></p>",k={},l=function(){d.call([{methodname:"tool_broadcast_get_broadcasts",args:{contextid:g}}])[0].done(function(a){var b=JSON.parse(a);for(var c in b){var d=b[c].id;k[d]=b[c]}}).fail(function(){window.console.error(new Error("Failed to get broadcast messages"))})},m=function(){if(document.hasFocus()){d.call([{methodname:"tool_broadcast_check_broadcasts",args:{contextid:g,userid:h}}],!0,!1)[0].done(function(a){var b=JSON.parse(a);if(b){l()}}).fail(function(){window.console.error(new Error("Failed to check broadcast messages"))})}},n=function(a){if(!i.getRoot()[0].classList.contains("show")){i.setTitle(a.title);i.setBody(a.body);i.footer[0].dataset.id=a.id;i.show();delete k[a]}},o=function(a){var b="tool-broadcast-notification-"+a.id,c=document.getElementById(b);if(null===c){var d=document.createElement("span"),f=document.createElement("h4"),g=document.createElement("span");d.id=b;f.classList.add("alert-heading");f.innerHTML=a.title;g.innerHTML=a.body;d.appendChild(f);d.appendChild(g);e.addNotification({message:d.outerHTML,type:"warn"}).then(function(){var a=document.getElementById("user-notifications");a.addEventListener("click",r)}).catch(function(){window.console.error(new Error("Failed to get broadcast message"))});delete k[a]}},p=function(){if(document.hasFocus()){for(var a in k){if(1==k[a].mode){n(k[a])}else if(2==k[a].mode){o(k[a])}else if(3==k[a].mode){n(k[a]);o(k[a])}break}}},q=function(){i.setBody(j);var a=i.footer[0].dataset.id;delete k[a];d.call([{methodname:"tool_broadcast_acknowledge_broadcast",args:{contextid:g,broadcastid:a}}])[0].fail(function(){e.exception(new Error("Failed to acknowledge broadcast messages"))})},r=function(a){var b=a.target.tagName.toLowerCase();if("button"===b){for(var c=a.target.parentElement.childNodes,f=0;f<c.length;f++){if(c[f].tagName!==void 0&&"span"===c[f].tagName.toLowerCase()){var h=c[f].id.substring(28);delete k[h];d.call([{methodname:"tool_broadcast_acknowledge_broadcast",args:{contextid:g,broadcastid:h}}])[0].fail(function(){e.exception(new Error("Failed to acknowledge broadcast messages"))})}}}},s=function(){return new Promise(function(d,e){a.get_string("loading","tool_broadcast").then(function(a){var e=document.createElement("input");e.type="button";e.value="Acknowledge";e.id="tool-broadcast-accept-broadcast";e.classList.add("btn","btn-primary","d-flex","ml-auto","mr-auto");b.create({type:b.types.DEFAULT,title:a,body:j,footer:e.outerHTML,large:!0}).done(function(a){i=a;i.getRoot().on("click","#tool-broadcast-accept-broadcast",function(a){a.preventDefault();i.hide()});i.getRoot().on(c.hidden,q);d()})}).catch(function(){e(new Error("Failed to load string: loading"))})})};f.init=function(a,b){g=a;h=b;var c=Math.floor(Math.random()*(6e4-45000+1))+45000;s().then(function(){m();setInterval(m,c);setInterval(p,5e3)}).catch(function(){e.exception(new Error("Failed to create broadcast modal"))})};return f});
//# sourceMappingURL=broadcast_modal.min.js.map
