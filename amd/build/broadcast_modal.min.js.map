{"version":3,"sources":["../src/broadcast_modal.js"],"names":["define","Str","ModalFactory","ModalEvents","Ajax","Notification","BroadcastModal","contextid","modalObj","spinner","messageQueue","getMessages","call","methodname","args","done","response","messages","JSON","parse","message","messageId","id","fail","window","console","error","Error","checkMessages","document","hasFocus","responseObj","displayMessageModal","getRoot","classList","contains","setTitle","title","setBody","body","footer","dataset","show","displayMessageNotification","containerid","existingContainer","getElementById","container","createElement","header","add","innerHTML","appendChild","addNotification","outerHTML","type","displayMessages","mode","acceptMessageModal","broadcastid","exception","acceptMessageNotification","event","elementName","target","tagName","toLowerCase","parentElement","notificationChildren","childNodes","i","length","substring","createModal","Promise","resolve","reject","get_string","then","footerBtn","value","create","types","DEFAULT","large","modal","on","e","preventDefault","hide","hidden","catch","init","context","interval","Math","floor","random","setInterval","addEventListener"],"mappings":"AAwBAA,OAAM,kCAAC,CAAC,UAAD,CAAa,oBAAb,CAAmC,mBAAnC,CAAwD,WAAxD,CAAqE,mBAArE,CAAD,CACN,SAASC,CAAT,CAAcC,CAAd,CAA4BC,CAA5B,CAAyCC,CAAzC,CAA+CC,CAA/C,CAA6D,IAKrDC,CAAAA,CAAc,CAAG,EALoC,CAMrDC,CANqD,CAOrDC,CAPqD,CAQrDC,CAAO,oFAR8C,CAWrDC,CAAY,CAAG,EAXsC,CAiBrDC,CAAW,CAAG,UAAW,CACzBP,CAAI,CAACQ,IAAL,CAAU,CAAC,CACPC,UAAU,CAAE,+BADL,CAEPC,IAAI,CAAE,CAACP,SAAS,CAAEA,CAAZ,CAFC,CAAD,CAAV,EAGI,CAHJ,EAGOQ,IAHP,CAGY,SAASC,CAAT,CAAmB,CAC3B,GAAIC,CAAAA,CAAQ,CAAGC,IAAI,CAACC,KAAL,CAAWH,CAAX,CAAf,CACA,IAAK,GAAII,CAAAA,CAAT,GAAoBH,CAAAA,CAApB,CAA8B,CAC1B,GAAII,CAAAA,CAAS,CAAGJ,CAAQ,CAACG,CAAD,CAAR,CAAkBE,EAAlC,CACAZ,CAAY,CAACW,CAAD,CAAZ,CAA0BJ,CAAQ,CAACG,CAAD,CACrC,CACJ,CATD,EASGG,IATH,CASQ,UAAW,CACfC,MAAM,CAACC,OAAP,CAAeC,KAAf,CAAqB,GAAIC,CAAAA,KAAJ,CAAU,kCAAV,CAArB,CACH,CAXD,CAYH,CA9BwD,CAqCrDC,CAAa,CAAG,UAAW,CAC3B,GAAIC,QAAQ,CAACC,QAAT,EAAJ,CAAyB,CACrB1B,CAAI,CAACQ,IAAL,CAAU,CAAC,CACPC,UAAU,CAAE,iCADL,CAEPC,IAAI,CAAE,CAACP,SAAS,CAAEA,CAAZ,CAFC,CAAD,CAAV,QAGiB,CAHjB,EAGoBQ,IAHpB,CAGyB,SAASC,CAAT,CAAmB,CACxC,GAAIe,CAAAA,CAAW,CAAGb,IAAI,CAACC,KAAL,CAAWH,CAAX,CAAlB,CACA,GAAIe,CAAJ,CAAiB,CACbpB,CAAW,EACd,CACJ,CARD,EAQGY,IARH,CAQQ,UAAW,CACfC,MAAM,CAACC,OAAP,CAAeC,KAAf,CAAqB,GAAIC,CAAAA,KAAJ,CAAU,oCAAV,CAArB,CACH,CAVD,CAWH,CACJ,CAnDwD,CA0DrDK,CAAmB,CAAG,SAASZ,CAAT,CAAkB,CACxC,GAAI,CAACZ,CAAQ,CAACyB,OAAT,GAAmB,CAAnB,EAAsBC,SAAtB,CAAgCC,QAAhC,CAAyC,MAAzC,CAAL,CAAuD,CACnD3B,CAAQ,CAAC4B,QAAT,CAAkBhB,CAAO,CAACiB,KAA1B,EACA7B,CAAQ,CAAC8B,OAAT,CAAiBlB,CAAO,CAACmB,IAAzB,EACA/B,CAAQ,CAACgC,MAAT,CAAgB,CAAhB,EAAmBC,OAAnB,CAA2BnB,EAA3B,CAAgCF,CAAO,CAACE,EAAxC,CACAd,CAAQ,CAACkC,IAAT,GAGA,MAAOhC,CAAAA,CAAY,CAACU,CAAD,CACtB,CACJ,CApEwD,CA2ErDuB,CAA0B,CAAG,SAASvB,CAAT,CAAkB,IAC3CwB,CAAAA,CAAW,CAAG,+BAAiCxB,CAAO,CAACE,EADZ,CAE3CuB,CAAiB,CAAGhB,QAAQ,CAACiB,cAAT,CAAwBF,CAAxB,CAFuB,CAI/C,GAA0B,IAAtB,GAAAC,CAAJ,CAAgC,IACxBE,CAAAA,CAAS,CAAGlB,QAAQ,CAACmB,aAAT,CAAuB,MAAvB,CADY,CAExBC,CAAM,CAAGpB,QAAQ,CAACmB,aAAT,CAAuB,IAAvB,CAFe,CAGxBT,CAAI,CAAGV,QAAQ,CAACmB,aAAT,CAAuB,MAAvB,CAHiB,CAK5BD,CAAS,CAACzB,EAAV,CAAesB,CAAf,CACAK,CAAM,CAACf,SAAP,CAAiBgB,GAAjB,CAAqB,eAArB,EACAD,CAAM,CAACE,SAAP,CAAmB/B,CAAO,CAACiB,KAA3B,CACAE,CAAI,CAACY,SAAL,CAAiB/B,CAAO,CAACmB,IAAzB,CAEAQ,CAAS,CAACK,WAAV,CAAsBH,CAAtB,EACAF,CAAS,CAACK,WAAV,CAAsBb,CAAtB,EAEAlC,CAAY,CAACgD,eAAb,CAA6B,CACzBjC,OAAO,CAAE2B,CAAS,CAACO,SADM,CAEzBC,IAAI,CAAE,MAFmB,CAA7B,EAMA,MAAO7C,CAAAA,CAAY,CAACU,CAAD,CACtB,CAEJ,CArGwD,CA0GrDoC,CAAe,CAAG,UAAW,CAC7B,GAAI3B,QAAQ,CAACC,QAAT,EAAJ,CAAyB,CAErB,IAAK,GAAIV,CAAAA,CAAT,GAAoBV,CAAAA,CAApB,CAAkC,CAC9B,GAAkC,CAA9B,EAAAA,CAAY,CAACU,CAAD,CAAZ,CAAsBqC,IAA1B,CAAqC,CACjCzB,CAAmB,CAACtB,CAAY,CAACU,CAAD,CAAb,CACtB,CAFD,IAEO,IAAkC,CAA9B,EAAAV,CAAY,CAACU,CAAD,CAAZ,CAAsBqC,IAA1B,CAAqC,CACxCd,CAA0B,CAACjC,CAAY,CAACU,CAAD,CAAb,CAC7B,CAFM,IAEA,IAAkC,CAA9B,EAAAV,CAAY,CAACU,CAAD,CAAZ,CAAsBqC,IAA1B,CAAqC,CACxCzB,CAAmB,CAACtB,CAAY,CAACU,CAAD,CAAb,CAAnB,CACAuB,CAA0B,CAACjC,CAAY,CAACU,CAAD,CAAb,CAC7B,CAGD,KACH,CACJ,CACJ,CA3HwD,CAgIrDsC,CAAkB,CAAG,UAAW,CAChClD,CAAQ,CAAC8B,OAAT,CAAiB7B,CAAjB,EACA,GAAIkD,CAAAA,CAAW,CAAGnD,CAAQ,CAACgC,MAAT,CAAgB,CAAhB,EAAmBC,OAAnB,CAA2BnB,EAA7C,CACA,MAAOZ,CAAAA,CAAY,CAACiD,CAAD,CAAnB,CAEAvD,CAAI,CAACQ,IAAL,CAAU,CAAC,CACPC,UAAU,CAAE,sCADL,CAEPC,IAAI,CAAE,CAACP,SAAS,CAAEA,CAAZ,CAAuBoD,WAAW,CAAEA,CAApC,CAFC,CAAD,CAAV,EAGI,CAHJ,EAGOpC,IAHP,CAGY,UAAW,CACnBlB,CAAY,CAACuD,SAAb,CAAuB,GAAIjC,CAAAA,KAAJ,CAAU,0CAAV,CAAvB,CACH,CALD,CAMH,CA3IwD,CAgJrDkC,CAAyB,CAAG,SAASC,CAAT,CAAgB,CAC5C,GAAIC,CAAAA,CAAW,CAAGD,CAAK,CAACE,MAAN,CAAaC,OAAb,CAAqBC,WAArB,EAAlB,CAEA,GAAoB,QAAhB,GAAAH,CAAW,EAAgE,oBAA/C,EAAAD,CAAK,CAACE,MAAN,CAAaG,aAAb,CAA2BA,aAA3B,CAAyC7C,EAAzE,CAAqG,CAGjG,OADI8C,CAAAA,CAAoB,CAAGN,CAAK,CAACE,MAAN,CAAaG,aAAb,CAA2BE,UACtD,CAASC,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGF,CAAoB,CAACG,MAAzC,CAAiDD,CAAC,EAAlD,CAAsD,CAClD,GAAKF,CAAoB,CAACE,CAAD,CAApB,CAAwBL,OAAxB,SAAD,EAAsG,MAAlD,GAAAG,CAAoB,CAACE,CAAD,CAApB,CAAwBL,OAAxB,CAAgCC,WAAhC,EAAxD,CAAmH,CAC/G,GAAIP,CAAAA,CAAW,CAAGS,CAAoB,CAACE,CAAD,CAApB,CAAwBhD,EAAxB,CAA2BkD,SAA3B,CAAqC,EAArC,CAAlB,CACA,MAAO9D,CAAAA,CAAY,CAACiD,CAAD,CAAnB,CACAvD,CAAI,CAACQ,IAAL,CAAU,CAAC,CACPC,UAAU,CAAE,sCADL,CAEPC,IAAI,CAAE,CAACP,SAAS,CAAEA,CAAZ,CAAuBoD,WAAW,CAAEA,CAApC,CAFC,CAAD,CAAV,EAGI,CAHJ,EAGOpC,IAHP,CAGY,UAAW,CACnBlB,CAAY,CAACuD,SAAb,CAAuB,GAAIjC,CAAAA,KAAJ,CAAU,0CAAV,CAAvB,CACH,CALD,CAMH,CACJ,CACJ,CACJ,CAnKwD,CA0KrD8C,CAAW,CAAG,UAAW,CACzB,MAAO,IAAIC,CAAAA,OAAJ,CAAY,SAASC,CAAT,CAAkBC,CAAlB,CAA0B,CACzC3E,CAAG,CAAC4E,UAAJ,CAAe,SAAf,CAA0B,gBAA1B,EAA4CC,IAA5C,CAAiD,SAASzC,CAAT,CAAgB,CAE7D,GAAI0C,CAAAA,CAAS,CAAGlD,QAAQ,CAACmB,aAAT,CAAuB,OAAvB,CAAhB,CACA+B,CAAS,CAACxB,IAAV,CAAiB,QAAjB,CACAwB,CAAS,CAACC,KAAV,CAAkB,aAAlB,CACAD,CAAS,CAACzD,EAAV,CAAe,iCAAf,CACAyD,CAAS,CAAC7C,SAAV,CAAoBgB,GAApB,CAAwB,KAAxB,CAA+B,aAA/B,CAA8C,QAA9C,CAAwD,SAAxD,CAAmE,SAAnE,EAEAhD,CAAY,CAAC+E,MAAb,CAAoB,CAChB1B,IAAI,CAAErD,CAAY,CAACgF,KAAb,CAAmBC,OADT,CAEhB9C,KAAK,CAAEA,CAFS,CAGhBE,IAAI,CAAE9B,CAHU,CAIhB+B,MAAM,CAAEuC,CAAS,CAACzB,SAJF,CAKhB8B,KAAK,GALW,CAApB,EAOCrE,IAPD,CAOM,SAASsE,CAAT,CAAgB,CAClB7E,CAAQ,CAAG6E,CAAX,CACA7E,CAAQ,CAACyB,OAAT,GAAmBqD,EAAnB,CAAsB,OAAtB,CAA+B,kCAA/B,CAAmE,SAASC,CAAT,CAAY,CAC3EA,CAAC,CAACC,cAAF,GACAhF,CAAQ,CAACiF,IAAT,EACH,CAHD,EAIAjF,CAAQ,CAACyB,OAAT,GAAmBqD,EAAnB,CAAsBnF,CAAW,CAACuF,MAAlC,CAA0ChC,CAA1C,EACAiB,CAAO,EAEV,CAhBD,CAiBH,CAzBD,EAyBGgB,KAzBH,CAyBS,UAAW,CAChBf,CAAM,CAAC,GAAIjD,CAAAA,KAAJ,CAAU,gCAAV,CAAD,CACT,CA3BD,CA4BH,CA7BM,CA8BV,CAzMwD,CA8MzDrB,CAAc,CAACsF,IAAf,CAAsB,SAASC,CAAT,CAAkB,CACpCtF,CAAS,CAAGsF,CAAZ,CADoC,GAOhCC,CAAAA,CAAQ,CAAGC,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,MAAL,IADhB,GACiC,OAAY,CAA7B,CAAX,OAPqB,CAUpCxB,CAAW,GACVK,IADD,CACM,UAAW,CACblD,CAAa,GACbsE,WAAW,CAACtE,CAAD,CAAgBkE,CAAhB,CAAX,CACAI,WAAW,CAAC1C,CAAD,CAAkB,GAAlB,CACd,CALD,EAMCmC,KAND,CAMO,UAAW,CACdtF,CAAY,CAACuD,SAAb,CAAuB,GAAIjC,CAAAA,KAAJ,CAAU,kCAAV,CAAvB,CACH,CARD,EAWAE,QAAQ,CAACsE,gBAAT,CAA0B,OAA1B,CAAmCtC,CAAnC,CAEH,CAvBD,CAyBA,MAAOvD,CAAAA,CACV,CAzOK,CAAN","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module provides the broadcast message modal that displays messages to users.\n *\n * @module     broadcast\n * @package    tool\n * @copyright  2020 Matt Porritt <mattp@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/str', 'core/modal_factory', 'core/modal_events', 'core/ajax', 'core/notification'],\nfunction(Str, ModalFactory, ModalEvents, Ajax, Notification) {\n\n    /**\n     * Module level variables.\n     */\n    var BroadcastModal = {};\n    var contextid;\n    var modalObj;\n    var spinner = '<p class=\"text-center\">'\n        + '<i class=\"fa fa-spinner fa-pulse fa-2x fa-fw\"></i>'\n        + '</p>';\n    var messageQueue = {};\n\n    /**\n     * Get broadcast messages for this user.\n     * This is only called if the check messages method returns true.\n     */\n    var getMessages = function() {\n        Ajax.call([{\n            methodname: 'tool_broadcast_get_broadcasts',\n            args: {contextid: contextid}\n        }])[0].done(function(response) {\n            var messages = JSON.parse(response);\n            for (var message in messages) {\n                var messageId = messages[message].id;\n                messageQueue[messageId] = messages[message];\n            }\n        }).fail(function() {\n            window.console.error(new Error('Failed to get broadcast messages'));\n        });\n    };\n\n    /**\n     * Check to see if there are messages available.\n     * This is done as a discrete ajax call, so we don't update the user session\n     * everytime we poll, and prevent the user from being logged out due to inactivity.\n     */\n    var checkMessages = function() {\n        if (document.hasFocus()) {\n            Ajax.call([{\n                methodname: 'tool_broadcast_check_broadcasts',\n                args: {contextid: contextid}\n            }], true, false)[0].done(function(response) {\n                var responseObj = JSON.parse(response);\n                if (responseObj) { // We have messages.\n                    getMessages();\n                }\n            }).fail(function() {\n                window.console.error(new Error('Failed to check broadcast messages'));\n            });\n        }\n    };\n\n    /**\n     * Display message to user as a modal.\n     *\n     * @param {object} message The message to display.\n     */\n    var displayMessageModal = function(message) {\n        if (!modalObj.getRoot()[0].classList.contains('show')) {\n            modalObj.setTitle(message.title);\n            modalObj.setBody(message.body);\n            modalObj.footer[0].dataset.id = message.id;\n            modalObj.show();\n\n            // Remove the message from the queue.\n            delete messageQueue[message];\n        }\n    };\n\n    /**\n     * Display message to user as a boostrap notification.\n     *\n     * @param {object} message The message to display.\n     */\n    var displayMessageNotification = function(message) {\n        var containerid = 'tool-broadcast-notification-' + message.id;\n        var existingContainer = document.getElementById(containerid);\n\n        if (existingContainer === null) {\n            var container = document.createElement('span');\n            var header = document.createElement('h4');\n            var body = document.createElement('span');\n\n            container.id = containerid;\n            header.classList.add('alert-heading');\n            header.innerHTML = message.title;\n            body.innerHTML = message.body;\n\n            container.appendChild(header);\n            container.appendChild(body);\n\n            Notification.addNotification({\n                message: container.outerHTML,\n                type: 'warn'\n            });\n\n            // Remove the message from the queue.\n            delete messageQueue[message];\n        }\n\n    };\n\n    /**\n     * Display the message to the user.\n     */\n    var displayMessages = function() {\n        if (document.hasFocus()) {\n            // If modal window is not currently displayed, check for queue messages.\n            for (var message in messageQueue) {\n                if (messageQueue[message].mode == 1) { // Display the message in a modal.\n                    displayMessageModal(messageQueue[message]);\n                } else if (messageQueue[message].mode == 2) { // Display the message as notification.\n                    displayMessageNotification(messageQueue[message]);\n                } else if (messageQueue[message].mode == 3) { // Display the message both ways.\n                    displayMessageModal(messageQueue[message]);\n                    displayMessageNotification(messageQueue[message]);\n                }\n\n                // Exit the loop after showing one message.\n                break;\n            }\n        }\n    };\n\n    /**\n     * Process user acknowledging the message.\n     */\n    var acceptMessageModal = function() {\n        modalObj.setBody(spinner);\n        var broadcastid = modalObj.footer[0].dataset.id;\n        delete messageQueue[broadcastid];\n\n        Ajax.call([{\n            methodname: 'tool_broadcast_acknowledge_broadcast',\n            args: {contextid: contextid, broadcastid: broadcastid}\n        }])[0].fail(function() {\n            Notification.exception(new Error('Failed to acknowledge broadcast messages'));\n        });\n    };\n\n    /**\n     * Process user acknowledging the message.\n     */\n    var acceptMessageNotification = function(event) {\n        var elementName = event.target.tagName.toLowerCase();\n        // Check correct thing was clicked.\n        if (elementName === 'button' && event.target.parentElement.parentElement.id == 'user-notifications') {\n            // Get the ID of the notification\n            var notificationChildren = event.target.parentElement.childNodes;\n            for (var i = 0; i < notificationChildren.length; i++) {\n                if ((notificationChildren[i].tagName !== undefined) && (notificationChildren[i].tagName.toLowerCase() === 'span')) {\n                    var broadcastid = notificationChildren[i].id.substring(28);\n                    delete messageQueue[broadcastid];\n                    Ajax.call([{\n                        methodname: 'tool_broadcast_acknowledge_broadcast',\n                        args: {contextid: contextid, broadcastid: broadcastid}\n                    }])[0].fail(function() {\n                        Notification.exception(new Error('Failed to acknowledge broadcast messages'));\n                    });\n                }\n            }\n        }\n    };\n\n    /**\n     * Create the modal window.\n     *\n     * @private\n     */\n    var createModal = function() {\n        return new Promise(function(resolve, reject) {\n            Str.get_string('loading', 'tool_broadcast').then(function(title) {\n                // Create the Modal.\n                var footerBtn = document.createElement('input');\n                footerBtn.type = 'button';\n                footerBtn.value = 'Acknowledge';\n                footerBtn.id = 'tool-broadcast-accept-broadcast';\n                footerBtn.classList.add('btn', 'btn-primary', 'd-flex', 'ml-auto', 'mr-auto');\n\n                ModalFactory.create({\n                    type: ModalFactory.types.DEFAULT,\n                    title: title,\n                    body: spinner,\n                    footer: footerBtn.outerHTML, // Mooodle 3.5 compatibility fix.\n                    large: true\n                })\n                .done(function(modal) {\n                    modalObj = modal;\n                    modalObj.getRoot().on('click', '#tool-broadcast-accept-broadcast', function(e) {\n                        e.preventDefault();\n                        modalObj.hide();\n                    });\n                    modalObj.getRoot().on(ModalEvents.hidden, acceptMessageModal);\n                    resolve();\n\n                });\n            }).catch(function() {\n                reject(new Error('Failed to load string: loading'));\n            });\n        });\n    };\n\n    /**\n     * Initiliase the modal display and associated listeners.\n     */\n    BroadcastModal.init = function(context) {\n        contextid = context;\n\n        // We don't want every user making ajax requests at the same time.\n        // So we add some randomness to the check interval at creation time.\n        var min = 45000;\n        var max = 60000;\n        var interval = Math.floor(Math.random() * (max - min + 1)) + min;\n\n        // TODO: add chain for create modal then to check messages.\n        createModal()\n        .then(function() {\n            checkMessages(); // Do an initial broadcast message check once things are loaded.\n            setInterval(checkMessages, interval); // Check messages at a regular interval.\n            setInterval(displayMessages, 5000); // Display messages at a regular interval, can be more frequent.\n        })\n        .catch(function() {\n            Notification.exception(new Error('Failed to create broadcast modal'));\n        });\n\n        // Add event listener that will handle bootstrap click.\n        document.addEventListener('click', acceptMessageNotification);\n\n    };\n\n    return BroadcastModal;\n});\n"],"file":"broadcast_modal.min.js"}