{"version":3,"sources":["../src/broadcast_modal.js"],"names":["define","Str","ModalFactory","ModalEvents","Ajax","Notification","BroadcastModal","contextid","modalObj","spinner","messageQueue","getMessages","call","methodname","args","done","response","messages","JSON","parse","message","messageId","id","fail","window","console","error","Error","checkMessages","document","hasFocus","responseObj","displayMessageModal","getRoot","classList","contains","setTitle","title","setBody","body","footer","dataset","show","displayMessageNotification","containerid","existingContainer","getElementById","container","createElement","header","add","innerHTML","appendChild","addNotification","outerHTML","type","then","notificationContainer","addEventListener","acceptMessageNotification","displayMessages","mode","acceptMessageModal","broadcastid","exception","event","elementName","target","tagName","toLowerCase","notificationChildren","parentElement","childNodes","i","length","substring","createModal","Promise","resolve","reject","get_string","footerBtn","value","create","types","DEFAULT","large","modal","on","e","preventDefault","hide","hidden","catch","init","context","interval","Math","floor","random","setInterval"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module provides the broadcast message modal that displays messages to users.\n *\n * @module     broadcast\n * @package    tool\n * @copyright  2020 Matt Porritt <mattp@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/str', 'core/modal_factory', 'core/modal_events', 'core/ajax', 'core/notification'],\nfunction(Str, ModalFactory, ModalEvents, Ajax, Notification) {\n\n    /**\n     * Module level variables.\n     */\n    var BroadcastModal = {};\n    var contextid;\n    var modalObj;\n    const spinner = '<p class=\"text-center\">'\n        + '<i class=\"fa fa-spinner fa-pulse fa-2x fa-fw\"></i>'\n        + '</p>';\n    var messageQueue = {};\n\n    /**\n     * Get broadcast messages for this user.\n     * This is only called if the check messages method returns true.\n     */\n    const getMessages = function() {\n        Ajax.call([{\n            methodname: 'tool_broadcast_get_broadcasts',\n            args: {contextid: contextid}\n        }])[0].done((response) => {\n            let messages = JSON.parse(response);\n            for (const message in messages) {\n                let messageId = messages[message].id;\n                messageQueue[messageId] = messages[message];\n            }\n        }).fail(() => {\n            window.console.error(new Error('Failed to get broadcast messages'));\n        });\n    };\n\n    /**\n     * Check to see if there are messages available.\n     * This is done as a discrete ajax call, so we don't update the user session\n     * everytime we poll, and prevent the user from being logged out due to inactivity.\n     */\n    const checkMessages = function() {\n        if (document.hasFocus()) {\n            Ajax.call([{\n                methodname: 'tool_broadcast_check_broadcasts',\n                args: {contextid: contextid}\n            }], true, false)[0].done((response) => {\n                let responseObj = JSON.parse(response);\n                if (responseObj) { // We have messages.\n                    getMessages();\n                }\n            }).fail(() => {\n                window.console.error(new Error('Failed to check broadcast messages'));\n            });\n        }\n    };\n\n    /**\n     * Display message to user as a modal.\n     *\n     * @param {object} message The message to display.\n     */\n    const displayMessageModal = function(message) {\n        if (!modalObj.getRoot()[0].classList.contains('show')) {\n            modalObj.setTitle(message.title);\n            modalObj.setBody(message.body);\n            modalObj.footer[0].dataset.id = message.id;\n            modalObj.show();\n\n            // Remove the message from the queue.\n            delete messageQueue[message];\n        }\n    };\n\n    /**\n     * Display message to user as a boostrap notification.\n     *\n     * @param {object} message The message to display.\n     */\n    const displayMessageNotification = function(message) {\n        const containerid = 'tool-broadcast-notification-' + message.id;\n        const existingContainer = document.getElementById(containerid);\n        //window.console.log(document.getElementById(containerid));\n\n        if (existingContainer === null) {\n            let container = document.createElement('span');\n            let header = document.createElement('h4');\n            let body = document.createElement('span');\n\n            container.id = containerid;\n            header.classList.add('alert-heading');\n            header.innerHTML = message.title;\n            body.innerHTML = message.body;\n\n            container.appendChild(header);\n            container.appendChild(body);\n\n            Notification.addNotification({\n                message: container.outerHTML,\n                type: 'warn'\n            })\n            .then(() => {\n                let notificationContainer = document.getElementById('user-notifications');\n                notificationContainer.addEventListener('click', acceptMessageNotification);\n            });\n\n            // Remove the message from the queue.\n            delete messageQueue[message];\n        }\n\n    };\n\n    /**\n     * Display the message to the user.\n     */\n    const displayMessages = function() {\n        if (document.hasFocus()) {\n            // If modal window is not currently displayed, check for queue messages.\n            for (const message in messageQueue) {\n                if (messageQueue[message].mode == 1) { // Display the message in a modal.\n                    displayMessageModal(messageQueue[message]);\n                } else if (messageQueue[message].mode == 2) { // Display the message as notification.\n                    displayMessageNotification(messageQueue[message]);\n                } else if (messageQueue[message].mode == 3) { // Display the message both ways.\n                    displayMessageModal(messageQueue[message]);\n                    displayMessageNotification(messageQueue[message]);\n                }\n\n                // Exit the loop after showing one message.\n                break;\n            }\n        }\n    };\n\n    /**\n     * Process user acknowledging the message.\n     */\n    const acceptMessageModal = function() {\n        modalObj.setBody(spinner);\n        let broadcastid = modalObj.footer[0].dataset.id;\n        delete messageQueue[broadcastid];\n\n        Ajax.call([{\n            methodname: 'tool_broadcast_acknowledge_broadcast',\n            args: {contextid: contextid, broadcastid: broadcastid}\n        }])[0].fail(() => {\n            Notification.exception(new Error('Failed to acknowledge broadcast messages'));\n        });\n    };\n\n    /**\n     * Process user acknowledging the message.\n     */\n    const acceptMessageNotification = function(event) {\n        const elementName = event.target.tagName.toLowerCase();\n        if (elementName === 'button') { // Correct thing was clicked.\n            // Get the ID of the notification\n            let notificationChildren = event.target.parentElement.childNodes;\n            for (let i = 0; i < notificationChildren.length; i++) {\n                if ((notificationChildren[i].tagName !== undefined) && (notificationChildren[i].tagName.toLowerCase() === 'span')) {\n                    const broadcastid = notificationChildren[i].id.substring(28);\n                    delete messageQueue[broadcastid];\n                    Ajax.call([{\n                        methodname: 'tool_broadcast_acknowledge_broadcast',\n                        args: {contextid: contextid, broadcastid: broadcastid}\n                    }])[0].fail(() => {\n                        Notification.exception(new Error('Failed to acknowledge broadcast messages'));\n                    });\n                }\n            }\n        }\n    };\n\n    /**\n     * Create the modal window.\n     *\n     * @private\n     */\n    const createModal = function() {\n        return new Promise((resolve, reject) => {\n            Str.get_string('loading', 'tool_broadcast').then((title) => {\n                // Create the Modal.\n                let footerBtn = document.createElement('input');\n                footerBtn.type = 'button';\n                footerBtn.value = 'Acknowledge';\n                footerBtn.id = 'tool-broadcast-accept-broadcast';\n                footerBtn.classList.add('btn', 'btn-primary', 'd-flex', 'ml-auto', 'mr-auto');\n\n                ModalFactory.create({\n                    type: ModalFactory.types.DEFAULT,\n                    title: title,\n                    body: spinner,\n                    footer: footerBtn.outerHTML, // Mooodle 3.5 compatibility fix.\n                    large: true\n                })\n                .done((modal) => {\n                    modalObj = modal;\n                    modalObj.getRoot().on('click', '#tool-broadcast-accept-broadcast', (e) => {\n                        e.preventDefault();\n                        modalObj.hide();\n                    });\n                    modalObj.getRoot().on(ModalEvents.hidden, acceptMessageModal);\n                    resolve();\n\n                });\n            }).catch(() => {\n                reject(new Error('Failed to load string: loading'));\n            });\n        });\n    };\n\n    /**\n     * Initiliase the modal display and associated listeners.\n     */\n    BroadcastModal.init = function(context) {\n        contextid = context;\n\n        // We don't want every user making ajax requests at the same time.\n        // So we add some randomness to the check interval at creation time.\n        let min = 45000;\n        let max = 60000;\n        let interval = Math.floor(Math.random() * (max - min + 1)) + min;\n\n        // TODO: add chain for create modal then to check messages.\n        createModal()\n        .then(() => {\n            checkMessages(); // Do an initial broadcast message check once things are loaded.\n            setInterval(checkMessages, interval); // Check messages at a regular interval.\n            setInterval(displayMessages, 5000); // Display messages at a regular interval, can be more frequent.\n        })\n        .catch(() => {\n            Notification.exception(new Error('Failed to create broadcast modal'));\n        });\n    };\n\n    return BroadcastModal;\n});\n"],"file":"broadcast_modal.min.js"}