{"version":3,"sources":["../src/broadcast_modal.js"],"names":["define","Str","ModalFactory","ModalEvents","Ajax","Notification","BroadcastModal","contextid","modalObj","spinner","messageQueue","getMessages","call","methodname","args","done","response","messages","JSON","parse","message","messageId","id","fail","exception","Error","checkMessages","responseObj","displayMessages","getRoot","classList","contains","setTitle","title","setBody","body","footer","dataset","show","acceptMessage","broadcastid","createModal","Promise","resolve","reject","get_string","then","footerBtn","document","createElement","type","value","add","create","types","DEFAULT","large","modal","on","e","preventDefault","hide","hidden","catch","init","context","interval","Math","floor","random","setInterval"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module provides the broadcast message modal that displays messages to users.\n *\n * @module     broadcast\n * @package    tool\n * @copyright  2020 Matt Porritt <mattp@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/str', 'core/modal_factory', 'core/modal_events', 'core/ajax', 'core/notification'],\nfunction(Str, ModalFactory, ModalEvents, Ajax, Notification) {\n\n    /**\n     * Module level variables.\n     */\n    var BroadcastModal = {};\n    var contextid;\n    var modalObj;\n    const spinner = '<p class=\"text-center\">'\n        + '<i class=\"fa fa-spinner fa-pulse fa-2x fa-fw\"></i>'\n        + '</p>';\n    var messageQueue = {};\n\n    /**\n     * Get broadcast messages for this user.\n     * This is only called if the check messages method returns true.\n     */\n    const getMessages = () => {\n        Ajax.call([{\n            methodname: 'tool_broadcast_get_broadcasts',\n            args: {contextid: contextid}\n        }])[0].done((response) => {\n            let messages = JSON.parse(response);\n            for (const message in messages) {\n                let messageId = messages[message].id;\n                messageQueue[messageId] = messages[message];\n            }\n        }).fail(() => {\n            Notification.exception(new Error('Failed to get broadcast messages'));\n        });\n    };\n\n    /**\n     * Check to see if there are messages available.\n     * This is done as a discrete ajax call, so we don't update the user session\n     * everytime we poll, and prevent the user from being logged out due to inactivity.\n     */\n    const checkMessages = () => {\n        Ajax.call([{\n            methodname: 'tool_broadcast_check_broadcasts',\n            args: {contextid: contextid}\n        }], true, false)[0].done((response) => {\n            let responseObj = JSON.parse(response);\n            if (responseObj) { // We have messages.\n                getMessages();\n            }\n        }).fail(() => {\n            Notification.exception(new Error('Failed to get broadcast messages'));\n        });\n\n    };\n\n    const displayMessages = () => {\n        // If modal window is not currently displayed, check for queue messages.\n        if (!modalObj.getRoot()[0].classList.contains('show')) {\n            for (const message in messageQueue) {\n                // Display the message in the modal.\n                modalObj.setTitle(messageQueue[message].title);\n                modalObj.setBody(messageQueue[message].body);\n                modalObj.footer[0].dataset.id = messageQueue[message].id;\n                modalObj.show();\n\n                // remove the message from the queue\n                delete messageQueue[message];\n\n                // Exit the loop after showing one message.\n                break;\n            }\n        }\n    };\n\n    const acceptMessage = () => {\n        modalObj.setBody(spinner);\n        let broadcastid = modalObj.footer[0].dataset.id;\n\n        Ajax.call([{\n            methodname: 'tool_broadcast_acknowledge_broadcast',\n            args: {contextid: contextid, broadcastid: broadcastid}\n        }])[0].fail(() => {\n            Notification.exception(new Error('Failed to acknowledge broadcast messages'));\n        });\n    };\n\n    /**\n     * Create the modal window.\n     *\n     * @private\n     */\n    const createModal = () => {\n        return new Promise((resolve, reject) => {\n            Str.get_string('loading', 'tool_broadcast').then((title) => {\n                // Create the Modal.\n                let footerBtn = document.createElement('input');\n                footerBtn.type = 'button';\n                footerBtn.value = 'Acknowledge';\n                footerBtn.id = 'tool-broadcast-accept-broadcast';\n                footerBtn.classList.add('btn', 'btn-primary', 'd-flex', 'ml-auto', 'mr-auto');\n\n                ModalFactory.create({\n                    type: ModalFactory.types.DEFAULT,\n                    title: title,\n                    body: spinner,\n                    footer: footerBtn,\n                    large: true\n                })\n                .done((modal) => {\n                    modalObj = modal;\n                    modalObj.getRoot().on('click', '#tool-broadcast-accept-broadcast', (e) => {\n                        e.preventDefault();\n                        modalObj.hide();\n                    });\n                    modalObj.getRoot().on(ModalEvents.hidden, acceptMessage);\n                    resolve();\n\n                });\n            }).catch(() => {\n                reject(new Error('Failed to load string: loading'));\n            });\n        });\n    };\n\n    BroadcastModal.init = function(context) {\n        contextid = context;\n\n        // We don't want every user making ajax requests at the same time.\n        // So we add some randomness to the check interval at creation time.\n        let min = 10000;\n        let max = 20000;\n        let interval = Math.floor(Math.random() * (max - min + 1)) + min;\n\n        // TODO: add chain for create modal then to check messages.\n        createModal()\n        .then(() => {\n            checkMessages(); // Do an initial broadcast message check once things are loaded.\n            setInterval(checkMessages, interval); // Check messages at a regular interval.\n            setInterval(displayMessages, 5000); // Display messages at a regular interval, can be more frequent.\n        })\n        .catch(() => {\n            Notification.exception(new Error('Failed to create broadcast modal'));\n        });\n    };\n\n    return BroadcastModal;\n});\n"],"file":"broadcast_modal.min.js"}