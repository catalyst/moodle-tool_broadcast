{"version":3,"sources":["../src/create_modal.js"],"names":["define","Str","ModalFactory","ModalEvents","Ajax","Fragment","Notification","CreateModal","contextid","modalObj","spinner","updateModalBody","formdata","params","JSON","stringify","get_string","then","title","setTitle","setBody","loadFragment","catch","exception","Error","processModalForm","e","preventDefault","copyform","getRoot","find","serialize","formjson","ariainvalid","errorclasses","invalid","length","concat","first","focus","call","methodname","args","jsonformdata","done","hide","fail","createModal","create","type","types","DEFAULT","body","large","modal","on","displayModalForm","show","init","context","createBroadcastButton","document","getElementById","addEventListener"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module provides the broadcast message create modal.\n *\n * @module     broadcast\n * @package    tool\n * @copyright  2020 Matt Porritt <mattp@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/str', 'core/modal_factory', 'core/modal_events', 'core/ajax', 'core/fragment', 'core/notification'],\n        function(Str, ModalFactory, ModalEvents, Ajax, Fragment, Notification) {\n\n    /**\n     * Module level variables.\n     */\n    var CreateModal = {};\n    var contextid;\n    var modalObj;\n    var spinner = '<p class=\"text-center\">'\n        + '<i class=\"fa fa-spinner fa-pulse fa-2x fa-fw\"></i>'\n        + '</p>';\n\n    /**\n     * Updates the body of the modal window.\n     *\n     * @param {Object} formdata\n     * @private\n     */\n    const updateModalBody = (formdata) => {\n        if (typeof formdata === \"undefined\") {\n            formdata = {};\n        }\n\n        let params = {\n                'jsonformdata': JSON.stringify(formdata),\n        };\n\n        Str.get_string('broadcastdetails', 'tool_broadcast').then((title) => {\n            modalObj.setTitle(title);\n            modalObj.setBody(Fragment.loadFragment('tool_broadcast', 'new_base_form', contextid, params));\n            return;\n        }).catch(() =>{\n            Notification.exception(new Error('Failed to load string: broadcastdetails'));\n        });\n    };\n\n    /**\n     * Updates Moodle form with selected information.\n     *\n     * @param {Object} e\n     * @private\n     */\n    const processModalForm = (e) => {\n        e.preventDefault(); // Stop modal from closing.\n\n        // Form data.\n        let copyform = modalObj.getRoot().find('form').serialize();\n        let formjson = JSON.stringify(copyform);\n\n        // Handle invalid form fields for better UX.\n        let ariainvalid = modalObj.getRoot().find('[aria-invalid=\"true\"]');\n        let errorclasses = modalObj.getRoot().find('.error');\n        let invalid;\n\n        if (ariainvalid.length) {\n            invalid = ariainvalid.concat(errorclasses);\n        }\n\n        if (invalid !== undefined && invalid.length) {\n            invalid.first().focus();\n            return;\n        }\n\n        // Submit form via ajax.\n        Ajax.call([{\n            methodname: 'tool_broadcast_submit_create_form',\n            args: {jsonformdata: formjson}\n        }])[0].done(() => {\n            // For submission succeeded.\n            modalObj.setBody(spinner);\n            modalObj.hide();\n        }).fail(() => {\n            // Form submission failed server side, redisplay with errors.\n            updateModalBody(copyform);\n        });\n\n    };\n\n    /**\n     * Create the modal window.\n     *\n     * @private\n     */\n    const createModal = () => {\n        Str.get_string('loading', 'tool_broadcast').then((title) => {\n            // Create the Modal.\n            ModalFactory.create({\n                type: ModalFactory.types.DEFAULT,\n                title: title,\n                body: spinner,\n                large: true\n            })\n            .done((modal) => {\n                modalObj = modal;\n                // Explicitly handle form click events.\n                modalObj.getRoot().on('click', '#id_submitbutton', processModalForm);\n                modalObj.getRoot().on('click', '#id_cancel', (e) => {\n                    e.preventDefault();\n                    modalObj.setBody(spinner);\n                    modalObj.hide();\n                });\n            });\n            return;\n        }).catch(() => {\n            Notification.exception(new Error('Failed to load string: loading'));\n        });\n    };\n\n    const displayModalForm = () => {\n        updateModalBody();\n        modalObj.show();\n    };\n\n    CreateModal.init = function(context) {\n        contextid = context;\n        createModal(); // Setup the initial Modal.\n\n        let createBroadcastButton = document.getElementById('local-broadcast-add-broadcast');\n        createBroadcastButton.addEventListener('click', displayModalForm);\n\n    };\n\n    return CreateModal;\n});\n"],"file":"create_modal.min.js"}